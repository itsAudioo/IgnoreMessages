name: Build & Release IgnoreMessages

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get last commit message
        id: commit
        run: |
          echo "LAST_COMMIT=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          echo "Last commit: $LAST_COMMIT"

      - name: Extract version
        id: version
        run: |
          if [[ "$LAST_COMMIT" =~ \[release\]\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "Detected release version: $VERSION"
          else
            echo "No [release] version found in commit message. Skipping."
            exit 0
          fi
        shell: bash

      - name: Build IgnoreMessages
        run: |
          msbuild IgnoreMessages/IgnoreMessages.csproj /p:Configuration=Release

      - name: Prepare release folder
        run: |
          mkdir -p IgnoreMessages
          mkdir -p IgnoreMessages/$VERSION
          copy IgnoreMessages\bin\Release\*.* IgnoreMessages\$VERSION

      - name: Create release zip
        run: |
          powershell Compress-Archive -Path IgnoreMessages\$VERSION\* -DestinationPath IgnoreMessages.zip -Force

      - name: Upload release artifact
        uses: actions/upload-artifact@v3
        with:
          name: IgnoreMessages-release
          path: IgnoreMessages.zip
