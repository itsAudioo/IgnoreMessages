name: Build & Release IgnoreMessages

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get last commit message
        id: commit
        run: |
          $commit = git log -1 --pretty=%B
          echo "LAST_COMMIT=$commit" >> $env:GITHUB_ENV
          Write-Host "Last commit: $commit"
        shell: pwsh

      - name: Extract version
        id: version
        run: |
          if ($env:LAST_COMMIT -match '\[release\] v([0-9]+\.[0-9]+\.[0-9]+)') {
            $version = $matches[1]
            echo "VERSION=$version" >> $env:GITHUB_ENV
            Write-Host "Detected release version: $version"
          } else {
            Write-Host "No [release] version found. Skipping."
            exit 0
          }
        shell: pwsh

      - name: Build IgnoreMessages
        run: msbuild IgnoreMessages/IgnoreMessages.csproj /p:Configuration=Release
        shell: pwsh

      - name: Prepare release folder
        run: |
          $releaseFolder = "IgnoreMessages\$env:VERSION"
          New-Item -ItemType Directory -Force -Path $releaseFolder | Out-Null
          Copy-Item -Path "IgnoreMessages/bin/Release/*" -Destination $releaseFolder -Force
        shell: pwsh

      - name: Create release zip
        run: |
          Compress-Archive -Path "IgnoreMessages\$env:VERSION\*" -DestinationPath "IgnoreMessages.zip" -Force
        shell: pwsh

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: IgnoreMessages-release
          path: IgnoreMessages.zip
